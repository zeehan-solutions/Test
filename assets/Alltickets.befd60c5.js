import{r as n,K as ee,W as te,v as o,j as t,B as E,M as w}from"./index.6f6a8d80.js";import{s as j,C as re,I as ae,f as se,g as ne,h as R,b as oe,T as ie}from"./App.c605b380.js";import{h as P}from"./moment.ef14f9cc.js";import{C as ce}from"./createhelpdesk.7d4db264.js";import{B as de}from"./Backbutton.039e979b.js";const le=j.button`
  background-color: #0C1539 !important;
  width: 200px;
  padding: 10px;
  color: white;
  cursor: pointer;
  border-radius: 10px!important;
  transition: background-color 0.3s;

  &:hover {
    background-color: #1a2447 !important;
  }
`;j.button`
  background-color:rgb(231, 231, 231) !important;
  width: 300px;
  padding: 10px;
  color: black;
  border: none;
  cursor: pointer;
  transition: background-color 0.3s;
`;const ke=()=>{const[b,q]=n.exports.useState(!1),[L,S]=n.exports.useState([]),[A,$]=n.exports.useState(""),[_,O]=n.exports.useState([]),[C,he]=n.exports.useState("newest");n.exports.useState(!1);const[d,Y]=n.exports.useState(1),[p]=n.exports.useState(5),i=localStorage.getItem("user_role"),v=localStorage.getItem("user_id"),k=ee(),[I,z]=n.exports.useState(!1),[F,G]=n.exports.useState({}),U=te(),h=new URLSearchParams(U.search).get("tab")||"1",N=()=>{z(!I)},x=localStorage.getItem("authToken"),u=localStorage.getItem("user_id"),y=async()=>{try{if(!x){console.error("No token found, please login.");return}let e="https://bapi.reownlogics.com/api/help-desk",r={employee_id:u};const s={2:7,3:4,4:3,5:2,7:6};h==="6"?(e="https://bapi.reownlogics.com/api/help-desk",r={manager_status_id:3,department_manager_id:u,employee_status_id:6}):h==="4"?(e=`https://bapi.reownlogics.com/api/help-desk?manager_status_id=3&employee_id=${u}`,r={}):s[h]&&(r={employee_status_id:s[h],employee_id:u});const a=await w.get(e,{params:r,headers:{Authorization:`Bearer ${x}`}});console.log("Filtered tickets for tab:",h,a.data),console.log("sortedemployees",a.data);const c=a.data.sort((g,m)=>new Date(m.created_at)-new Date(g.created_at));O(c)}catch(e){console.error("Error fetching employee data: ",e)}};n.exports.useEffect(()=>{y()},[x,k]);const H=(e,r)=>C==="newest"?new Date(r.createdAt)-new Date(e.createdAt):C==="oldest"?new Date(e.createdAt)-new Date(r.createdAt):0,l=_.filter(e=>e.title.toLowerCase().includes(A.toLowerCase())).sort(H),D=d*p,K=D-p,V=l.slice(K,D),T=e=>Y(e),W=()=>{q(!b),S(b?[]:_.map(e=>e.id))},J=e=>{S(r=>r.includes(e)?r.filter(s=>s!==e):[...r,e])},Q=async()=>{try{const e=localStorage.getItem("authToken");if(!e){console.error("No token found, redirecting to login."),k("/login");return}const r=[...new Set(l.map(a=>a.department.id))];console.log("Department IDs:",r);const s={};for(let a of r){const c=await w.get(`https://bapi.reownlogics.com/api/department/assistants?department_id=${a}`,{headers:{Authorization:`Bearer ${e}`}});Array.isArray(c.data)?s[a]=c.data:Array.isArray(c.data.department)?s[a]=c.data.department:console.error("Unexpected API response:",c.data)}G(s)}catch(e){console.error("API error:",e)}};n.exports.useEffect(()=>{l.length>0&&Q()},[l]);const X=async(e,r)=>{e.preventDefault();const s=parseInt(e.target.value,10);if(!s){console.error("Assistant selection is required");return}try{const a=await w.post("https://bapi.reownlogics.com/api/help-desk/assign",{assistant_id:s,help_desk_id:r},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`}});console.log("Manager assigned successfully:",a.data),y()}catch(a){console.error("Error assigning manager:",a)}};return o("div",{children:[o("div",{className:"d-flex justify-content-between align-items-center",children:[t(de,{}),t(le,{className:"mb-2",onClick:N,children:"+ Create New"}),t(ce,{isOpen:I,toggle:N,refreshTickets:y})]}),o(re,{className:"bg-white ticket-card",style:{borderRadius:"30px"},children:[o("div",{className:"p-2 d-flex justify-content-between align-items-center",children:[t("div",{children:t("h3",{children:"Recent Ticket"})}),t("div",{className:"d-flex align-items-center justify-content-end",children:o(ae,{className:"mr-3",children:[t(se,{style:{borderRight:0},children:t(ne,{size:16})}),t(R,{placeholder:"Search by name",value:A,onChange:e=>$(e.target.value),style:{borderLeft:0}})]})})]}),o(oe,{children:[o(ie,{responsive:!0,className:"table-ticket",children:[t("thead",{children:o("tr",{children:[t("th",{children:t("input",{type:"checkbox",checked:b,onChange:W})}),t("th",{children:"Name"}),t("th",{children:"Requested Date"}),t("th",{children:"Requested Time"}),t("th",{children:"Assign By"}),(i==="hr"||i==="manager"||i==="employee")&&t("th",{children:"Rating"}),t("th",{children:"Status"}),(i==="hr"||i==="manager")&&t("th",{children:"Assign to"}),t("th",{children:"Actions"})]})}),t("tbody",{children:V.map(e=>{var a,c,g,m,B,M;const r=((a=e.department)==null?void 0:a.id)||null,s=F[r]||[];return o("tr",{children:[t("td",{children:t("input",{type:"checkbox",checked:L.includes(e.id),onChange:()=>J(e.id)})}),t("td",{children:e.title}),t("td",{children:t("span",{style:{background:"rgba(58, 151, 76, 0.1)",padding:"10px",borderRadius:"100px",color:"#3A974C"},children:P(e.created_at).format("YYYY-MM-DD")})}),t("td",{children:P(e.created_at).format("hh:mm:ss A")}),t("td",{children:((g=(c=e.department)==null?void 0:c.manager)==null?void 0:g.name)||"N/A"}),(i==="hr"||i==="manager"||i==="employee")&&t("td",{children:((m=e.reviews)==null?void 0:m.length)>0?e.reviews[0].rating:"No rating"}),t("td",{children:t("span",{style:{background:"rgba(58, 151, 76, 0.1)",padding:"10px",borderRadius:"100px",color:"#3A974C"},children:e.status})}),(i==="hr"||i==="manager")&&t("td",{children:e.status==="rejected"?t("span",{children:"Can't assign, it's rejected"}):e.assigned_to===null?((M=(B=e.department)==null?void 0:B.manager)==null?void 0:M.id)===Number(v)&&e.requested_by!==Number(v)?o(R,{type:"select",name:"select",onChange:f=>X(f,e.id),children:[t("option",{value:"",children:"Select Assistant"}),s.length>0?s.map((f,Z)=>t("option",{value:f.assistant.id,children:f.assistant.name},Z)):t("option",{disabled:!0,children:"No managers available"})]}):t("span",{children:"You cannot assign"}):t("span",{children:e.assistant.name})}),t("td",{children:t("button",{type:"button",onClick:()=>k(`/ticket-detail/${e.id}`),className:"btn btn-outline-primary rounded-pill",children:"View"})})]},e.id)})})]}),o("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[t(E,{disabled:d===1,onClick:()=>T(d-1),children:"Previous"}),o("div",{children:["Page ",d," of ",Math.ceil(l.length/p)]}),t(E,{disabled:d===Math.ceil(l.length/p),onClick:()=>T(d+1),children:"Next"})]})]})]})]})};export{ke as default};
